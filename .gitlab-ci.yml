################################################################################
# GitLab CI/CD Pipeline
# CJ Oliveyoung - Backend API
#
# Flow: GitLab Push → Docker Build → ECR Push → ArgoCD 자동 배포
################################################################################

stages:
  - build

variables:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: 160884802838.dkr.ecr.ap-northeast-2.amazonaws.com
  ECR_REPOSITORY: oliveyoung-api
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

# ------------------------------------------------------------------------------
# Build Stage: Docker 이미지 빌드 → ECR Push
# ArgoCD가 k8s/deployment.yaml의 latest 태그를 감지하여 자동 배포
# ------------------------------------------------------------------------------
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - cd backend
    - docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
    - docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
  only:
    - main
