################################################################################
# GitLab CI/CD Pipeline
# CJ Oliveyoung - Backend API
#
# Flow: Test → Build → Scan → (Manual) Load Test
#       GitLab Push → JUnit 테스트 → Docker Build → ECR Push
#       → Trivy 보안 스캔 → ArgoCD 자동 배포
################################################################################

stages:
  - test
  - build
  - scan
  - deploy
  - load-test

variables:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: 160884802838.dkr.ecr.ap-northeast-2.amazonaws.com
  ECR_REPOSITORY: oliveyoung-api
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

# ------------------------------------------------------------------------------
# Test Stage: JUnit 단위 테스트
# 테스트 실패 시 빌드/배포 차단
# ------------------------------------------------------------------------------
test:
  stage: test
  image: gradle:8.5-jdk17
  script:
    - cd backend
    - gradle test --no-daemon
  artifacts:
    when: always
    reports:
      junit: backend/build/test-results/test/*.xml
    paths:
      - backend/build/reports/tests/
    expire_in: 7 days
  only:
    - main
    - merge_requests

# ------------------------------------------------------------------------------
# Build Stage: Docker 이미지 빌드 → ECR Push
# 커밋 SHA 태그 + latest 태그를 모두 Push (latest는 fallback용)
# ------------------------------------------------------------------------------
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - cd backend
    - docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
    - docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
  only:
    - main

# ------------------------------------------------------------------------------
# Scan Stage: Trivy 이미지 보안 스캔
# ECR에 Push된 이미지의 CVE 취약점 검사
# CRITICAL 취약점 발견 시 리포트 생성 (allow_failure로 배포는 차단 안 함)
# ------------------------------------------------------------------------------
trivy-scan:
  stage: scan
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache aws-cli curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    - trivy image --exit-code 0 --severity HIGH,CRITICAL --format table $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    - trivy image --exit-code 1 --severity CRITICAL --format json --output trivy-report.json $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || true
  artifacts:
    when: always
    paths:
      - trivy-report.json
    expire_in: 30 days
  allow_failure: true
  only:
    - main

# ------------------------------------------------------------------------------
# Deploy Stage: Manifest 이미지 태그 자동 업데이트
# deployment.yaml의 IMAGE_TAG를 커밋 SHA로 교체 → Git Push
# ArgoCD가 이 변경을 감지하여 EKS에 새 이미지 롤링 배포
#
# [트러블슈팅 배경]
# 문제: CI에서 ECR에 새 이미지를 Push했지만, deployment.yaml이
#       :latest 고정이라 ArgoCD가 변경을 감지하지 못해 배포 안 됨
# 해결: 이미지 태그를 커밋 SHA로 변경하고, CI가 YAML을 자동 수정 후
#       Git Push → ArgoCD가 태그 변경 감지 → 자동 배포
# ------------------------------------------------------------------------------
update_manifest:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache git sed
    # GitLab CI에서 Git Push를 위한 인증 설정
    - git config user.email "ci-bot@oliveyoung.com"
    - git config user.name "CI Bot"
    - git remote set-url origin https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
  script:
    # 1. deployment.yaml의 이미지 태그를 현재 커밋 SHA로 교체
    #    IMAGE_TAG(플레이스홀더) 또는 이전 SHA 모두 매칭하여 새 SHA로 교체
    #    K8s YAML에 $변수를 직접 쓰면 해석 안 되므로 sed로 리터럴 교체
    - sed -i "s|oliveyoung-api:[a-zA-Z0-9_-]*|oliveyoung-api:${CI_COMMIT_SHORT_SHA}|g" k8s/deployment.yaml
    # 2. 변경 확인 (CI 로그에서 태그가 올바르게 교체되었는지 확인용)
    - echo "Updated image tag to ${CI_COMMIT_SHORT_SHA}"
    - grep "image:" k8s/deployment.yaml
    # 3. Git에 커밋 & Push → ArgoCD가 감지
    - git add k8s/deployment.yaml
    - git commit -m "chore: update image tag to ${CI_COMMIT_SHORT_SHA} [skip ci]" || echo "No changes to commit"
    - git push origin HEAD:main
  only:
    - main

# ------------------------------------------------------------------------------
# Load Test Stage: k6 부하 테스트 (수동 트리거)
# 세일 이벤트 트래픽 시뮬레이션
# ------------------------------------------------------------------------------
load-test:
  stage: load-test
  image:
    name: grafana/k6:latest
    entrypoint: [""]
  script:
    - k6 run k6/load-test.js
  variables:
    BASE_URL: "http://localhost:8080"
  artifacts:
    when: always
    paths:
      - k6-summary.json
    expire_in: 7 days
  when: manual
  only:
    - main
