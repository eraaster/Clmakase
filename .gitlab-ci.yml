################################################################################
# GitLab CI/CD Pipeline
# CJ Oliveyoung - Backend API
#
# Flow: GitLab Push → Docker Build → ECR Push → K8s 매니페스트 이미지 태그 업데이트
################################################################################

stages:
  - build
  - deploy

variables:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: 160884802838.dkr.ecr.ap-northeast-2.amazonaws.com
  ECR_REPOSITORY: oliveyoung-api
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - cd backend
    - docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
    - docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
  only:
    - main

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache git sed
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    # 1. 이미지 태그 업데이트
    - sed -i "s|image:.*${ECR_REPOSITORY}.*|image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}|" k8s/deployment.yaml
    # 2. 변경사항 커밋
    - git add k8s/deployment.yaml
    - git commit -m "chore: update image tag to ${IMAGE_TAG} [skip ci]"
    # 3. 토큰을 이용한 인증 및 Push (가장 중요)
    - git push https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:main
  only:
    - main